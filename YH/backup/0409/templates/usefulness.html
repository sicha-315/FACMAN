<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ì œì¡° ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œ</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
  <link rel="stylesheet" href="{{ url_for('static', filename='usefulness.css') }}" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="{{ url_for('static', filename='usefulness.js') }}" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.3.2/socket.io.min.js"></script>
</head>
<body>
  <!-- âœ… ìƒë‹¨ í—¤ë” -->
  <header>
    <div><strong>ì œì¡° ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œ</strong></div>
    <div class="header-right">
      <div class="user-icon">ğŸ‘¤ <span class="user-name">í™ê¸¸ë™(ëŒ€ë¦¬)</span></div>
      <div class="clock" id="clock">--:--:--</div>
      <div>ğŸ”” ì•Œë¦¼ 3ê±´</div>
    </div>
  </header>

  <!-- âœ… ì¢Œì¸¡ ì‚¬ì´ë“œë°” -->
  <nav class="sidebar">
    <div class="logo-box">
      <img src="{{ url_for('static', filename='images/facman.png') }}" alt="FACMAN Logo" class="logo-img" />
    </div>
    <h2>ğŸ“Š ëŒ€ì‹œë³´ë“œ</h2>
    <a href="{{ url_for('index') }}">ğŸ  ë©”ì¸ í˜ì´ì§€</a>
    <a href="{{ url_for('usefulness') }}">ğŸ–¥ï¸ P1-A</a>
    <a href="server_A2.html">ğŸ–¥ï¸ P1-B</a>
    <a href="server_B1.html">ğŸ–¥ï¸ P2-A</a>
    <a href="server_B2.html">ğŸ–¥ï¸ P2-B</a>
    <a href="{{ url_for('report_page') }}">ğŸ“ ë³´ê³ ì„œ ìƒì„±</a>
  </nav>

  <!-- âœ… ë©”ì¸ ì½˜í…ì¸  ë° ì˜¤ë¥¸ìª½ ì‚¬ì´ë“œë°” -->
  <div class="layout-column">
    <div class="main-wrapper">
      <div class="main">

        <!-- âœ… P1-A ì„œë²„ ìœ ìš©ì„± ì •ë³´ -->
        <div class="section">
          <h2>P1-A ì„œë²„ ê°€ë™ í˜„í™©</h2>
          <div class="grid-4col">
            <div class="stat-card" style="width: 100%">
              <h3>P1-A ì„œë²„ ìƒíƒœ</h3>
              <div id="P1-A_status" class="status-box">
                <span class="status-value">loading...</span>
              </div>
            </div>
            <div class="stat-card">
              <h3>ê°€ë™ë¥ </h3>
              <iframe src="http://192.168.0.61:3000/d-solo/fehyt45zciqrkc/new-dashboard3?orgId=1&from=1743788428260&to=1743831628260&panelId=1" frameborder="0" style="width:100%; height: 200px;"></iframe>
            </div>
            <div class="stat-card">
              <h3>ìƒì‚°ì„±</h3>
              <iframe src="http://192.168.0.61:3000/d-solo/fehyt45zciqrkc/new-dashboard3?orgId=1&from=1743810443982&to=1743832043982&panelId=2" frameborder="0" style="width:100%; height: 200px;"></iframe>
            </div>
            <div class="stat-card">
              <h3>ì–‘í’ˆë¥ </h3>
              <iframe src="http://192.168.0.61:3000/d-solo/fehyt45zciqrkc/new-dashboard3?orgId=1&from=1743753975831&to=1743840375831&panelId=6" frameborder="0" style="width:100%; height: 200px;"></iframe>
            </div>
          </div>
        </div>

        <!-- âœ… ê³µì • ì´ë²¤íŠ¸ ìš”ì•½ -->
        <div class="section">
          <h2>ê³µì • ì´ë²¤íŠ¸ í˜„í™©</h2>
          <div class="grid-4col">
            <div class="chart-box">
              <h3>ì´ë²¤íŠ¸ ìœ í˜•ë³„ ë°œìƒ íšŸìˆ˜</h3>
              <iframe src="http://192.168.0.61:3000/d-solo/fehyt45zciqrkc/new-dashboard3?panelId=4" frameborder="0" style="width:100%; height:100%;"></iframe>
            </div>
            <div class="info-box" style="grid-column: span 3;">
              <h3>ì‹¤ì‹œê°„ ì´ë²¤íŠ¸ ë¡œê·¸</h3>
              <iframe src="http://192.168.0.61:3000/d-solo/fehyt45zciqrkc/new-dashboard3?panelId=7" frameborder="0" style="width:100%; height: 300px;"></iframe>
            </div>
          </div>
        </div>
      </div>

      <!-- âœ… ì˜¤ë¥¸ìª½ ì‚¬ì´ë“œë°” -->
      <aside class="right-sidebar">
        <div class="section chatbot">
          <h2>ğŸ’¬ ì±—ë´‡</h2>
          <div id="chatHistory" class="chat-history"></div>
          <div class="chat-input-box">
            <textarea id="chatInput" placeholder="ì˜ˆ: P1-A ê°€ë™ë¥  ì•Œë ¤ì¤˜"></textarea>
            <div class="chat-buttons">
              <button id="chatSendBtn">ì§ˆë¬¸í•˜ê¸°</button>
              <button id="chatClearBtn" class="clear-btn" title="ëŒ€í™” ì´ˆê¸°í™”">ğŸ—‘ï¸</button>
            </div>
          </div>
        </div>
      </aside>
    </div>
  </div>

  <!-- âœ… ìŠ¤í¬ë¦½íŠ¸ -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const socket = io('http://172.18.192.1:5000', { transports: ['websocket'] });
      const statusMap = {
        "processing": "#4CAF50",
        "repair": "orange",
        "maintenance": "yellow",
        "failure": "red"
      };

      function updateStatus(id, eventType) {
        const box = document.getElementById(id);
        if (box) {
          box.querySelector('.status-value').textContent = `${eventType}`;
          box.style.backgroundColor = statusMap[eventType] || "#444";
        }
      }

      socket.on('status_update', (data) => {
        if (data['P1-A']) {
          updateStatus('P1-A_status', data['P1-A']['event_type']);
        }
      });

      function updateClock() {
        const now = new Date();
        document.getElementById("clock").textContent = now.toLocaleString("ko-KR", { hour12: false });
      }
      updateClock();
      setInterval(updateClock, 1000);

      const sendBtn = document.getElementById("chatSendBtn");
      const clearBtn = document.getElementById("chatClearBtn");
      const input = document.getElementById("chatInput");
      const history = document.getElementById("chatHistory");

      if (sendBtn) sendBtn.addEventListener("click", sendLangGraphMessage);
      if (clearBtn) clearBtn.addEventListener("click", () => {
        history.innerHTML = "";
      });

      input.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          sendLangGraphMessage();
        }
      });

      function sendLangGraphMessage() {
        const message = input.value.trim();
        if (!message) return;

        const userMsg = document.createElement("div");
        userMsg.className = "chat-box";
        userMsg.innerHTML = `<div class="chat-message user">${message}</div>`;
        history.appendChild(userMsg);

        input.value = "";

        const botMsg = document.createElement("div");
        botMsg.className = "chat-box";
        botMsg.innerHTML = `<div class="chat-message bot">â³ ë‹µë³€ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>`;
        history.appendChild(botMsg);

        // ì˜ˆì‹œ: ì‹¤ì œ ì„œë²„ í˜¸ì¶œë¡œ êµì²´ ê°€ëŠ¥
        setTimeout(() => {
          botMsg.innerHTML = `<div class="chat-message bot">âœ… "${message}"ì— ëŒ€í•œ ë‹µë³€ì…ë‹ˆë‹¤.</div>`;
        }, 1000);
      }
    });
  </script>
</body>
</html>
